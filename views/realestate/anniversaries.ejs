<%- include('../layout-header', { title: 'Anniversaries' }) %>

<h1>Purchase Anniversaries</h1>

<input type="hidden" name="_csrf" value="<%= csrfToken %>">

<% if (user.role === 'admin') { %>
<div class="form-card digest-settings-section">
  <h2>Digest Email Settings</h2>
  <p style="color:#64748b; font-size:0.85rem; margin-bottom:1rem;">Configure daily anniversary digest emails sent to real estate users from the admin SMTP account.</p>
  <% if (typeof digestSettings !== 'undefined' && digestSettings.length > 0) { %>
  <table class="data-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Email</th>
        <th>Enabled</th>
        <th>Lookahead Days</th>
      </tr>
    </thead>
    <tbody>
      <% digestSettings.forEach(function(ds) { %>
      <tr>
        <td><%= ds.user_name %></td>
        <td><%= ds.user_email %></td>
        <td>
          <input type="checkbox" <%= ds.enabled ? 'checked' : '' %> onchange="updateDigestSetting(<%= ds.user_id %>, this.checked, this.closest('tr').querySelector('.digest-days').value)">
        </td>
        <td>
          <input type="number" class="digest-days" value="<%= ds.lookahead_days %>" min="1" max="30" style="width:60px" onchange="updateDigestSetting(<%= ds.user_id %>, this.closest('tr').querySelector('input[type=checkbox]').checked, this.value)">
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  <% } else { %>
    <p class="anniversary-empty">No real estate users configured yet.</p>
  <% } %>
</div>
<% } else if (user.role === 'realestate') { %>
<div class="form-card" style="margin-bottom: 1.5rem;">
  <div style="display: flex; align-items: center; gap: 1rem;">
    <label style="font-weight: 500; margin: 0;">Anniversary Digest Emails</label>
    <label class="field-toggle" style="margin: 0;">
      <input type="checkbox" id="my-digest-toggle" <%= myDigestEnabled ? 'checked' : '' %>
        onchange="updateDigestSetting(<%= user.id %>, this.checked, 7)">
      <span style="font-size: 0.85rem; color: #64748b;"><%= myDigestEnabled ? 'Enabled' : 'Disabled' %></span>
    </label>
  </div>
  <p style="color:#64748b; font-size:0.8rem; margin-top:0.5rem; margin-bottom:0;">
    When enabled, you'll receive daily email digests about upcoming purchase anniversaries.
  </p>
</div>
<% } %>

<!-- Today's Anniversaries -->
<div class="anniversary-section anniversary-section-today">
  <h2>Today <span class="count-badge"><%= today.length %></span></h2>
  <% if (today.length === 0) { %>
    <p class="anniversary-empty">No anniversaries today.</p>
  <% } else { %>
  <div class="anniversary-list">
    <% today.forEach(function(a) { %>
    <div class="anniversary-card" data-id="<%= a.id %>">
      <div class="anniversary-info">
        <div class="anniversary-name"><%= [a.first_name, a.last_name].filter(Boolean).join(' ') %></div>
        <div class="anniversary-detail">
          <strong><%= a.years %> year(s)</strong> at <%= a.property_address || 'N/A' %>
        </div>
        <div class="anniversary-contact-info">
          <% if (a.phone) { %><span>Phone: <%= a.phone %></span><% } %>
          <% if (a.email) { %><span>Email: <%= a.email %></span><% } %>
          <% if (!a.phone && !a.email) { %><span class="anniversary-warning">No phone or email</span><% } %>
        </div>
      </div>
      <div class="anniversary-actions">
        <% if (a.email) { %>
          <a href="/campaign/create?contact_id=<%= a.cid %>&channel=email" class="btn btn-sm btn-primary">Send Email</a>
        <% } %>
        <% if (a.phone) { %>
          <a href="/campaign/create?contact_id=<%= a.cid %>&channel=sms" class="btn btn-sm btn-secondary">Send Text</a>
        <% } %>
        <button class="btn btn-sm btn-danger skip-anniversary-btn" data-id="<%= a.id %>">Skip</button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<!-- This Week -->
<div class="anniversary-section anniversary-section-week">
  <h2>This Week <span class="count-badge"><%= thisWeek.length %></span></h2>
  <% if (thisWeek.length === 0) { %>
    <p class="anniversary-empty">No upcoming anniversaries this week.</p>
  <% } else { %>
  <div class="anniversary-list">
    <% thisWeek.forEach(function(a) { %>
    <div class="anniversary-card" data-id="<%= a.id %>">
      <div class="anniversary-info">
        <div class="anniversary-name"><%= [a.first_name, a.last_name].filter(Boolean).join(' ') %></div>
        <div class="anniversary-detail">
          <strong><%= a.years %> year(s)</strong> at <%= a.property_address || 'N/A' %> — <em><%= a.anniversary_date %></em>
        </div>
        <div class="anniversary-contact-info">
          <% if (a.phone) { %><span>Phone: <%= a.phone %></span><% } %>
          <% if (a.email) { %><span>Email: <%= a.email %></span><% } %>
        </div>
      </div>
      <div class="anniversary-actions">
        <% if (a.email) { %>
          <a href="/campaign/create?contact_id=<%= a.cid %>&channel=email" class="btn btn-sm btn-primary">Send Email</a>
        <% } %>
        <% if (a.phone) { %>
          <a href="/campaign/create?contact_id=<%= a.cid %>&channel=sms" class="btn btn-sm btn-secondary">Send Text</a>
        <% } %>
        <button class="btn btn-sm btn-danger skip-anniversary-btn" data-id="<%= a.id %>">Skip</button>
      </div>
    </div>
    <% }); %>
  </div>
  <% } %>
</div>

<!-- Completed -->
<% if (completed.length > 0) { %>
<div class="anniversary-section anniversary-section-done">
  <h2>Recently Completed <span class="count-badge"><%= completed.length %></span></h2>
  <div class="anniversary-list">
    <% completed.forEach(function(a) { %>
    <div class="anniversary-card anniversary-card-done">
      <div class="anniversary-info">
        <div class="anniversary-name"><%= [a.first_name, a.last_name].filter(Boolean).join(' ') %></div>
        <div class="anniversary-detail">
          <%= a.years %> year(s) at <%= a.property_address || 'N/A' %> — <%= a.anniversary_date %>
        </div>
      </div>
      <div class="anniversary-actions">
        <span class="badge badge-status-<%= a.status %>"><%= a.status %></span>
      </div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<a href="/realestate" class="btn btn-link" style="margin-top: 1rem; display: inline-block;">Back to Real Estate</a>

<script>window.CSRF_TOKEN = '<%= csrfToken %>';</script>
<%- include('../layout-footer', { scripts: ['/js/anniversaries.js'] }) %>
