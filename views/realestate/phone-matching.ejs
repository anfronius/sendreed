<%- include('../layout-header', { title: 'Phone & Email Matching' }) %>

<div class="page-header">
  <h1>Phone & Email Matching</h1>
  <div class="page-actions">
    <% if (counts.autoConfirmed + counts.confirmed > 0) { %>
      <button type="button" class="btn btn-primary" id="apply-all-btn"
        data-count="<%= counts.autoConfirmed + counts.confirmed %>">
        Apply All Confirmed (<%= counts.autoConfirmed + counts.confirmed %>)
      </button>
    <% } %>
    <a href="/realestate/import-vcard" class="btn btn-upload">Import Another vCard</a>
  </div>
</div>

<!-- Stats -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number"><%= counts.total %></div>
    <div class="stat-label">Total Contacts</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #166534;"><%= counts.confirmed + counts.autoConfirmed %></div>
    <div class="stat-label">Matched</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #92400e;"><%= counts.review %></div>
    <div class="stat-label">Needs Review</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #991b1b;"><%= counts.unmatched %></div>
    <div class="stat-label">No Match</div>
  </div>
</div>

<input type="hidden" name="_csrf" value="<%= csrfToken %>">

<% if (counts.total === 0) { %>
  <div class="empty-state">
    <p>No contacts need phone/email data. <a href="/realestate/import-vcard">Import a vCard file</a> to match contacts.</p>
  </div>
<% } else { %>

<!-- Section 1: Auto-Matched (high confidence, not yet applied) -->
<% if (autoConfirmed.length > 0) { %>
<div class="match-section match-section-green" id="section-confirmed">
  <h2>Auto-Matched <span class="count-badge"><%= autoConfirmed.length %></span></h2>
  <p class="match-section-desc">High-confidence matches (score >= 70). These will be applied when you click "Apply All Confirmed".</p>
  <div class="match-list">
    <% autoConfirmed.forEach(function(m) { %>
    <div class="match-card" data-match-id="<%= m.match_id %>">
      <div class="match-card-left">
        <div class="match-contact-name"><%= [m.c_first, m.c_last].filter(Boolean).join(' ') %></div>
        <% if (m.c_address) { %><div class="match-contact-detail"><%= m.c_address %></div><% } %>
        <div class="match-contact-detail" style="font-size:0.8rem; color:#94a3b8;">
          <% if (m.c_phone) { %>Phone: <%= m.c_phone %> <% } else { %><em>No phone</em> <% } %>
          <% if (m.c_email) { %>Email: <%= m.c_email %><% } else { %><em>No email</em><% } %>
        </div>
      </div>
      <div class="match-card-arrow">←</div>
      <div class="match-card-right">
        <div class="match-imported-name"><%= m.ic_name || [m.ic_first, m.ic_last].filter(Boolean).join(' ') %></div>
        <div class="match-imported-details">
          <% if (m.ic_phone) { %><span>Phone: <%= m.ic_phone %></span><% } %>
          <% if (m.ic_email) { %><span>Email: <%= m.ic_email %></span><% } %>
        </div>
      </div>
      <div class="match-card-actions">
        <span class="confidence-badge confidence-high"><%= m.confidence_score %>%</span>
        <button class="btn btn-sm btn-danger skip-match-btn" data-match-id="<%= m.match_id %>">Remove</button>
      </div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<!-- Section 1b: Already applied -->
<% if (confirmed.length > 0) { %>
<div class="match-section match-section-green">
  <h2>Applied <span class="count-badge"><%= confirmed.length %></span></h2>
  <div class="match-list">
    <% confirmed.forEach(function(m) { %>
    <div class="match-card match-card-applied">
      <div class="match-card-left">
        <div class="match-contact-name"><%= [m.c_first, m.c_last].filter(Boolean).join(' ') %></div>
        <% if (m.c_address) { %><div class="match-contact-detail"><%= m.c_address %></div><% } %>
      </div>
      <div class="match-card-arrow">←</div>
      <div class="match-card-right">
        <div class="match-imported-name"><%= m.ic_name || [m.ic_first, m.ic_last].filter(Boolean).join(' ') %></div>
        <div class="match-imported-details">
          <% if (m.ic_phone) { %><span>Phone: <%= m.ic_phone %></span><% } %>
          <% if (m.ic_email) { %><span>Email: <%= m.ic_email %></span><% } %>
        </div>
      </div>
      <div class="match-card-actions">
        <span class="confidence-badge confidence-high"><%= m.confidence_score %>%</span>
        <span class="badge badge-status-sent">Applied</span>
      </div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<!-- Section 2: Needs Review (low confidence) -->
<% if (needsReview.length > 0) { %>
<div class="match-section match-section-yellow" id="section-review">
  <h2>Needs Review <span class="count-badge"><%= needsReview.length %></span></h2>
  <p class="match-section-desc">Lower confidence matches. Review and confirm or skip each one.</p>
  <div class="match-list">
    <% needsReview.forEach(function(m) { %>
    <div class="match-card" data-match-id="<%= m.match_id %>">
      <div class="match-card-left">
        <div class="match-contact-name"><%= [m.c_first, m.c_last].filter(Boolean).join(' ') %></div>
        <% if (m.c_address) { %><div class="match-contact-detail"><%= m.c_address %></div><% } %>
        <div class="match-contact-detail" style="font-size:0.8rem; color:#94a3b8;">
          <% if (m.c_phone) { %>Phone: <%= m.c_phone %> <% } else { %><em>No phone</em> <% } %>
          <% if (m.c_email) { %>Email: <%= m.c_email %><% } else { %><em>No email</em><% } %>
        </div>
      </div>
      <div class="match-card-arrow">?</div>
      <div class="match-card-right">
        <div class="match-imported-name"><%= m.ic_name || [m.ic_first, m.ic_last].filter(Boolean).join(' ') %></div>
        <div class="match-imported-details">
          <% if (m.ic_phone) { %><span>Phone: <%= m.ic_phone %></span><% } %>
          <% if (m.ic_email) { %><span>Email: <%= m.ic_email %></span><% } %>
        </div>
      </div>
      <div class="match-card-actions">
        <span class="confidence-badge confidence-low"><%= m.confidence_score %>%</span>
        <button class="btn btn-sm btn-primary confirm-match-btn" data-match-id="<%= m.match_id %>">Confirm</button>
        <button class="btn btn-sm btn-danger skip-match-btn" data-match-id="<%= m.match_id %>">Skip</button>
      </div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<!-- Section 3: Unmatched (existing contacts with no vCard match) -->
<% if (unmatched.length > 0) { %>
<div class="match-section match-section-red" id="section-unmatched">
  <h2>No Match Found <span class="count-badge"><%= unmatched.length %></span></h2>
  <p class="match-section-desc">These contacts are missing phone or email and no vCard match was found. Search for a vCard import to assign manually.</p>
  <div class="match-list">
    <% unmatched.forEach(function(m) { %>
    <div class="match-card" data-contact-id="<%= m.contact_id %>">
      <div class="match-card-left">
        <div class="match-contact-name"><%= [m.c_first, m.c_last].filter(Boolean).join(' ') %></div>
        <% if (m.c_address) { %><div class="match-contact-detail"><%= m.c_address %></div><% } %>
        <div class="match-contact-detail" style="font-size:0.8rem; color:#94a3b8;">
          <% if (m.c_phone) { %>Phone: <%= m.c_phone %> <% } else { %><em>No phone</em> <% } %>
          <% if (m.c_email) { %>Email: <%= m.c_email %><% } else { %><em>No email</em><% } %>
        </div>
      </div>
      <div class="match-card-right" style="flex: 1;">
        <div class="manual-match-form">
          <input type="text" class="contact-search-input" placeholder="Search vCard imports by name..."
            data-contact-id="<%= m.contact_id %>">
          <div class="contact-search-results" data-contact-id="<%= m.contact_id %>"></div>
        </div>
      </div>
    </div>
    <% }); %>
  </div>
</div>
<% } %>

<% } %>

<a href="/realestate" class="btn btn-link" style="margin-top: 1rem; display: inline-block;">Back to Real Estate</a>

<script>window.CSRF_TOKEN = '<%= csrfToken %>';</script>
<%- include('../layout-footer', { scripts: ['/js/matching.js'] }) %>
