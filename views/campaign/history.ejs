<%- include('../layout-header', { title: 'Campaigns' }) %>

<div class="page-header">
  <h1>Campaigns <span class="count-badge"><%= totalCount %></span></h1>
  <div class="page-actions">
    <a href="/campaign/create" class="btn btn-primary">New Campaign</a>
  </div>
</div>

<% if (campaigns.length === 0) { %>
  <div class="empty-state">
    <p>No campaigns yet. <a href="/campaign/create">Create your first campaign</a>.</p>
  </div>
<% } else { %>
<div class="table-responsive">
  <table class="data-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Template</th>
        <th>Channel</th>
        <th>Status</th>
        <th>Sent</th>
        <th>Failed</th>
        <th>Total</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% campaigns.forEach(function(c) { %>
      <tr>
        <td><%= c.id %></td>
        <td><%= c.template_name || '(deleted)' %></td>
        <td><span class="badge badge-<%= c.channel %>"><%= c.channel %></span></td>
        <td><span class="badge badge-status-<%= c.status %>"><%= c.status %></span></td>
        <td><%= c.sent_count %></td>
        <td><%= c.failed_count %></td>
        <td><%= c.total_count %></td>
        <td><%= c.created_at %></td>
        <td>
          <% if (c.status === 'reviewing') { %>
            <a href="/campaign/<%= c.id %>/review" class="btn btn-sm btn-primary">Review</a>
          <% } else if (c.status === 'sending') { %>
            <a href="/campaign/<%= c.id %>/progress" class="btn btn-sm btn-primary">Progress</a>
          <% } else if (c.channel === 'sms' && c.status === 'sent') { %>
            <a href="/campaign/<%= c.id %>/sms" class="btn btn-sm btn-secondary">View Texts</a>
          <% } %>
          <% if (['sent', 'paused', 'resume_tomorrow'].includes(c.status) && c.failed_count > 0 && c.channel === 'email') { %>
            <form method="POST" action="/campaign/<%= c.id %>/retry" style="display:inline">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-sm btn-secondary">Retry Failed</button>
            </form>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<%- include('../partials/pagination', { currentPage, totalPages, baseUrl }) %>
<% } %>

<h2 style="margin-top: 2rem;">Templates <span class="count-badge"><%= templates ? templates.length : 0 %></span></h2>

<% if (templates && templates.length > 0) { %>
<div class="table-responsive">
  <table class="data-table" id="templates-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Scheduled</th>
        <th>Preview</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% templates.forEach(function(t) { %>
      <tr data-template-id="<%= t.id %>">
        <td><strong><%= t.name %></strong></td>
        <td><%= t.scheduled_date || '—' %></td>
        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; color: #64748b;">
          <% if (t.subject_template) { %>Subject: <%= t.subject_template %> — <% } %><%= t.body_template.substring(0, 100) %><%= t.body_template.length > 100 ? '...' : '' %>
        </td>
        <td>
          <button class="btn btn-sm btn-primary edit-template-btn" data-id="<%= t.id %>" data-name="<%= t.name %>" data-subject="<%= t.subject_template || '' %>" data-body="<%= t.body_template.replace(/"/g, '&quot;') %>" data-scheduled="<%= t.scheduled_date || '' %>">Edit</button>
          <button class="btn btn-sm btn-danger delete-template-btn" data-id="<%= t.id %>" data-name="<%= t.name %>">Delete</button>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } else { %>
  <div class="empty-state">
    <p>No templates yet. Create one when starting a new campaign.</p>
  </div>
<% } %>

<!-- Template Edit Modal -->
<div id="template-edit-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <h3 id="template-modal-title">Edit Template</h3>
    <input type="hidden" id="template-edit-id">
    <div class="form-group">
      <label for="template-edit-name">Name</label>
      <input type="text" id="template-edit-name">
    </div>
    <div class="form-group" id="template-edit-subject-group">
      <label for="template-edit-subject">Subject</label>
      <input type="text" id="template-edit-subject">
    </div>
    <div class="form-group">
      <label for="template-edit-body">Body</label>
      <textarea id="template-edit-body" rows="8"></textarea>
    </div>
    <div class="form-group">
      <label for="template-edit-scheduled">Scheduled Date (optional)</label>
      <input type="date" id="template-edit-scheduled">
      <small style="color:#64748b;">If set, this template will be auto-sent to all contacts on this date.</small>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="template-save-btn">Save</button>
      <button class="btn btn-secondary" id="template-cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<%- include('../layout-footer', { scripts: ['/js/campaign-history.js'] }) %>
