<%- include('../layout-header', { title: 'Campaigns' }) %>

<div class="page-header">
  <h1>Campaigns <span class="count-badge"><%= totalCount %></span></h1>
  <div class="page-actions">
    <a href="/campaign/create" class="btn btn-primary">New Campaign</a>
  </div>
</div>

<% if (campaigns.length === 0) { %>
  <div class="empty-state">
    <p>No campaigns yet. <a href="/campaign/create">Create your first campaign</a>.</p>
  </div>
<% } else { %>
<div class="table-responsive">
  <table class="data-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Template</th>
        <th>Channel</th>
        <th>Status</th>
        <th>Sent</th>
        <th>Failed</th>
        <th>Total</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% campaigns.forEach(function(c) { %>
      <tr>
        <td><%= c.id %></td>
        <td><%= c.template_name || '(deleted)' %></td>
        <td><span class="badge badge-<%= c.channel %>"><%= c.channel %></span></td>
        <td><span class="badge badge-status-<%= c.status %>"><%= c.status %></span></td>
        <td><%= c.sent_count %></td>
        <td><%= c.failed_count %></td>
        <td><%= c.total_count %></td>
        <td><%= c.created_at %></td>
        <td>
          <% if (c.status === 'reviewing') { %>
            <a href="/campaign/<%= c.id %>/review" class="btn btn-sm btn-primary">Review</a>
          <% } else if (c.status === 'sending') { %>
            <a href="/campaign/<%= c.id %>/progress" class="btn btn-sm btn-primary">Progress</a>
          <% } else if (c.channel === 'sms' && c.status === 'sent') { %>
            <a href="/campaign/<%= c.id %>/sms" class="btn btn-sm btn-secondary">View Texts</a>
          <% } %>
          <% if (['sent', 'paused', 'resume_tomorrow'].includes(c.status) && c.failed_count > 0 && c.channel === 'email') { %>
            <form method="POST" action="/campaign/<%= c.id %>/retry" style="display:inline">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-sm btn-secondary">Retry Failed</button>
            </form>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<%- include('../partials/pagination', { currentPage, totalPages, baseUrl }) %>
<% } %>

<% if (templates && templates.length > 0) { %>
<h2 style="margin-top: 2rem;">Templates</h2>
<div class="table-responsive">
  <table class="data-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Channel</th>
        <th>Preview</th>
      </tr>
    </thead>
    <tbody>
      <% templates.forEach(function(t) { %>
      <tr>
        <td><strong><%= t.name %></strong></td>
        <td><span class="badge badge-<%= t.channel %>"><%= t.channel %></span></td>
        <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; color: #64748b;">
          <% if (t.subject_template) { %>Subject: <%= t.subject_template %> â€” <% } %><%= t.body_template.substring(0, 120) %><%= t.body_template.length > 120 ? '...' : '' %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>
<% } %>

<%- include('../layout-footer', { scripts: [] }) %>
